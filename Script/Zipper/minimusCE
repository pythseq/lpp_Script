#!/pub/SOFTWARE/Scaffolding/amos/bin/runAmos -C
#? minimus2 - The AMOS Pipeline for merging 2 assemblies

#? Usage:          
#?         minimus2 prefix \
#?		-D REFCOUNT=<n>         \       # Number of sequences in the 1st assembly ; (Required)
#?		-D OVERLAP=<n> 		\       # Assembly 1 vs 2 minimum overlap (Default 40bp)
#?		-D CONSERR=<f>		\	# Maximum consensus error (0..1) (Default 0.06)
#?		-D MINID=<n>		\	# Minimum overlap percent identity for alignments (Default 94)
#?		-D MAXTRIM=<n>			# Maximum sequence trimming length (Default 20bp)

#--------------------------------------- USER DEFINED VALUES ------------------#

REFCOUNT= 0
MINID   = 94
OVERLAP	= 40
MAXTRIM = 20
WIGGLE  = 15
CONSERR = 0.06

#------------------------------------------------------------------------------#

TGT     = $(PREFIX).afg
BANK    = $(PREFIX).bnk
REFSEQ  = $(PREFIX).ref.seq
QRYSEQ  = $(PREFIX).qry.seq
ALIGN   = $(PREFIX).delta
COORDS  = $(PREFIX).coords
OVLTAB  = $(PREFIX).ovl
OVLTRIM = $(PREFIX).otr
OVLAMOS = $(PREFIX).OVL
CONTIG  = $(PREFIX).contig
FASTA   = $(PREFIX).fasta

SINGLETONS    = $(PREFIX).singletons
SINGLETONSEQ  = $(PREFIX).singletons.seq

#------------------------------------------------------------------------------#

INPUTS  = $(TGT) $(REFCOUNT)
OUTPUTS = $(CONTIG) $(FASTA)

#------------------------------------------------------------------------------#

BINDIR=/pub/SOFTWARE/Scaffolding/amos/bin
CELEDIR=./
NUCMER=nucmer
DELTAFILTER	= delta-filter
SHOWCOORDS	= show-coords

#------------------------------------------------------------------------------#

## Building AMOS bank & Dumping reads
10: rm -fr $(BANK)
11: $(BINDIR)/bank-transact -c -z -b $(BANK) -m $(TGT)
12: $(BINDIR)/dumpreads $(BANK) -M $(REFCOUNT) > $(REFSEQ)
13: $(BINDIR)/dumpreads $(BANK) -m $(REFCOUNT) > $(QRYSEQ)

## Getting overlaps 
20: $(NUCMER) -maxmatch -c $(OVERLAP) $(REFSEQ) $(QRYSEQ) -p $(PREFIX)
21: $(SHOWCOORDS) -H -c -l -o -T -r -I $(MINID) $(ALIGN) | egrep 'END|CONTAINS' > $(COORDS)
22: $(CELEDIR)/trans_overlap.py -i $(COORDS) -o  $(OVLTRIM)
23: $(CELEDIR)/combine_reads.py -i $(OVLTRIM) -r $(QRYSEQ) -o  $(FASTA)


